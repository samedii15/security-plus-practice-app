<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brute-Force Protection Dashboard - Admin</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .dashboard-container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
    }

    .stat-card.warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card.success {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card.info {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .stat-value {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 30px;
      margin-bottom: 30px;
    }

    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .chart-container h3 {
      margin-top: 0;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      margin-top: 20px;
    }

    .table-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow-x: auto;
    }

    .ban-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    .ban-table th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    .ban-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .ban-table tr:hover {
      background: #f5f5f5;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: 600;
    }

    .status-active {
      background: #fecaca;
      color: #991b1b;
    }

    .status-expired {
      background: #d1fae5;
      color: #065f46;
    }

    .status-escalated {
      background: #fef3c7;
      color: #92400e;
    }

    .refresh-status {
      text-align: center;
      color: #666;
      margin-bottom: 20px;
      font-size: 0.9em;
    }

    .refresh-status.updating {
      color: #667eea;
      font-weight: 600;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 15px;
      background: #f9fafb;
      border-radius: 8px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .unban-btn {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }

    .unban-btn:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
    }

    .unban-btn:active {
      transform: translateY(0);
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #dc2626;
    }

    @media (max-width: 768px) {
      .charts-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard-container">
    <div class="controls">
      <div>
        <h1 style="margin: 0;">üõ°Ô∏è Brute-Force Protection Dashboard</h1>
        <div class="refresh-status" id="refreshStatus">Loading data...</div>
      </div>
      <div>
        <button class="btn btn-secondary" onclick="toggleAutoRefresh()">
          <span id="refreshToggleText">‚è∏Ô∏è Pause Auto-Refresh</span>
        </button>
        <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh Now</button>
        <button class="btn btn-secondary" onclick="window.location.href='admin.html'">‚Üê Back</button>
      </div>
    </div>

    <div id="errorContainer"></div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Active IP Bans</div>
        <div class="stat-value" id="activeBans">-</div>
        <div style="font-size: 0.85em; margin-top: 10px;">Currently blocked IPs</div>
      </div>

      <div class="stat-card warning">
        <div class="stat-label">Account Locks</div>
        <div class="stat-value" id="activeLocks">-</div>
        <div style="font-size: 0.85em; margin-top: 10px;">Locked accounts</div>
      </div>

      <div class="stat-card success">
        <div class="stat-label">Escalated Bans</div>
        <div class="stat-value" id="escalatedBans">-</div>
        <div style="font-size: 0.85em; margin-top: 10px;">Persistent attackers (3+ bans/24h)</div>
      </div>

      <div class="stat-card info">
        <div class="stat-label">Tracked IPs</div>
        <div class="stat-value" id="trackedIps">-</div>
        <div style="font-size: 0.85em; margin-top: 10px;">IPs in memory</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <div class="chart-container">
        <h3>üìä Active Protections Breakdown</h3>
        <div class="chart-wrapper">
          <canvas id="protectionsPieChart"></canvas>
        </div>
      </div>

      <div class="chart-container">
        <h3>üìà Top 10 Banned IPs</h3>
        <div class="chart-wrapper">
          <canvas id="topIpsBarChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Ban History Table -->
    <div class="table-container">
      <h3>üö´ Recent Ban Activity</h3>
      <table class="ban-table">
        <thead>
          <tr>
            <th>IP Hash</th>
            <th>Ban Count (24h)</th>
            <th>Current Duration</th>
            <th>Expires At</th>
            <th>Status</th>
            <th>Total Attempts</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="banTableBody">
          <tr>
            <td colspan="7" style="text-align: center; color: #999;">Loading data...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Audit Logs Section -->
    <div class="table-container" style="margin-top: 30px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>üìã Authentication & Security Audit Logs</h3>
        <div>
          <label for="logLimit" style="margin-right: 10px;">Show:</label>
          <select id="logLimit" onchange="refreshData()" style="padding: 5px 10px; border-radius: 4px; border: 1px solid #ddd;">
            <option value="50">50 logs</option>
            <option value="100" selected>100 logs</option>
            <option value="200">200 logs</option>
            <option value="500">500 logs</option>
          </select>
        </div>
      </div>
      <table class="ban-table">
        <thead>
          <tr>
            <th>Timestamp</th>
            <th>Event Type</th>
            <th>User</th>
            <th>IP Address</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="auditLogsBody">
          <tr>
            <td colspan="5" style="text-align: center; color: #999;">Loading audit logs...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let autoRefreshEnabled = true;
    let refreshInterval = null;
    let charts = {};

    // Initialize charts
    function initCharts() {
      // Pie Chart
      const pieCtx = document.getElementById('protectionsPieChart').getContext('2d');
      charts.pie = new Chart(pieCtx, {
        type: 'doughnut',
        data: {
          labels: ['Active Bans', 'Account Locks', 'Escalated Bans'],
          datasets: [{
            data: [0, 0, 0],
            backgroundColor: [
              'rgba(102, 126, 234, 0.8)',
              'rgba(245, 87, 108, 0.8)',
              'rgba(251, 191, 36, 0.8)'
            ],
            borderColor: [
              'rgba(102, 126, 234, 1)',
              'rgba(245, 87, 108, 1)',
              'rgba(251, 191, 36, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 15,
                font: { size: 12 }
              }
            }
          }
        }
      });

      // Bar Chart
      const barCtx = document.getElementById('topIpsBarChart').getContext('2d');
      charts.bar = new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: 'Ban Count (24h)',
            data: [],
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    // Fetch and update data
    async function refreshData() {
      const statusEl = document.getElementById('refreshStatus');
      statusEl.textContent = 'Updating...';
      statusEl.classList.add('updating');

      try {
        // Check for both JWT token (from login) and admin token (from admin panel)
        const jwtToken = localStorage.getItem('token');
        const adminToken = localStorage.getItem('secplus_admin_token_v1');
        
        if (!jwtToken && !adminToken) {
          showError('Not authenticated. Please enter the ADMIN_TOKEN on the admin page first, then come back here.');
          statusEl.textContent = 'Authentication required';
          statusEl.classList.remove('updating');
          return;
        }

        // Use whichever token is available (prefer JWT, fallback to admin token)
        const headers = {};
        if (jwtToken) {
          headers['Authorization'] = `Bearer ${jwtToken}`;
        } else if (adminToken) {
          headers['x-admin-token'] = adminToken;
        }

        const response = await fetch('/api/admin/brute-force-stats', {
          headers: headers
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        updateDashboard(data);
        
        // Fetch audit logs
        const logLimit = document.getElementById('logLimit').value || 100;
        const logsResponse = await fetch(`/api/admin/audit-logs?limit=${logLimit}`, {
          headers: headers
        });
        
        if (logsResponse.ok) {
          const logs = await logsResponse.json();
          updateAuditLogs(logs);
        }
        
        const now = new Date().toLocaleTimeString();
        statusEl.textContent = `Last updated: ${now}`;
        statusEl.classList.remove('updating');
        clearError();
      } catch (err) {
        console.error('Dashboard refresh failed:', err);
        statusEl.textContent = 'Update failed';
        statusEl.classList.remove('updating');
        showError(`Failed to fetch data: ${err.message}`);
      }
    }

    // Update dashboard with new data
    function updateDashboard(data) {
      // Update stat cards
      document.getElementById('activeBans').textContent = data.active_bans || 0;
      document.getElementById('activeLocks').textContent = data.active_account_locks || 0;
      document.getElementById('escalatedBans').textContent = data.escalated_bans || 0;
      document.getElementById('trackedIps').textContent = data.tracked_ips || 0;

      // Update pie chart
      charts.pie.data.datasets[0].data = [
        data.active_bans || 0,
        data.active_account_locks || 0,
        data.escalated_bans || 0
      ];
      charts.pie.update();

      // Update bar chart
      const topIps = (data.top_banned_ips || []).slice(0, 10);
      charts.bar.data.labels = topIps.map(ip => ip.ip || ip.ip_hash.substring(0, 16) + '...');
      charts.bar.data.datasets[0].data = topIps.map(ip => ip.ban_count_24h);
      charts.bar.update();

      // Update table
      updateBanTable(data.top_banned_ips || []);
    }

    // Update ban history table
    function updateBanTable(bans) {
      const tbody = document.getElementById('banTableBody');
      
      if (bans.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #999;">No active bans</td></tr>';
        return;
      }

      tbody.innerHTML = bans.slice(0, 20).map(ban => {
        const isActive = new Date(ban.expires_at) > new Date();
        const isEscalated = ban.ban_count_24h >= 3;
        
        let statusClass = isActive ? 'status-active' : 'status-expired';
        let statusText = isActive ? 'Active' : 'Expired';
        
        if (isActive && isEscalated) {
          statusClass = 'status-escalated';
          statusText = 'Escalated';
        }

        const expiresAt = new Date(ban.expires_at).toLocaleString();
        const durationMins = Math.round(ban.duration_seconds / 60);

        return `
          <tr>
            <td><code>${ban.ip || ban.ip_hash.substring(0, 24) + '...'}</code></td>
            <td><strong>${ban.ban_count_24h}</strong></td>
            <td>${durationMins} min</td>
            <td>${expiresAt}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
            <td>${ban.attempt_count || 'N/A'}</td>
            <td>
              ${isActive ? `<button class="unban-btn" onclick="unbanIp('${ban.ip_hash}')">üîì Unban</button>` : '<span style="color: #666;">‚Äî</span>'}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Update audit logs table
    function updateAuditLogs(logs) {
      const tbody = document.getElementById('auditLogsBody');
      
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">No audit logs found</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map(log => {
        const timestamp = new Date(log.created_at).toLocaleString();
        const eventType = log.event_type || 'UNKNOWN';
        const userEmail = log.user_email || (log.user_id ? `User #${log.user_id}` : '‚Äî');
        const ipAddress = log.ip_address || '‚Äî';
        
        // Format details based on event type
        let details = '';
        try {
          const detailsObj = typeof log.details === 'string' ? JSON.parse(log.details) : log.details;
          
          if (eventType === 'LOGIN_SUCCESS') {
            details = '‚úÖ Login successful';
          } else if (eventType === 'LOGIN_FAILURE') {
            details = `‚ùå Login failed: ${detailsObj.reason || 'Invalid credentials'}`;
          } else if (eventType === 'REGISTER') {
            details = 'üìù New user registration';
          } else if (eventType === 'IP_BAN_TRIGGERED') {
            details = `üö´ IP banned (${detailsObj.attempt_count || 'N/A'} attempts)`;
          } else if (eventType === 'ACCOUNT_LOCKED') {
            details = `üîí Account locked (${detailsObj.failed_attempts || 'N/A'} failures)`;
          } else if (eventType === 'ACCOUNT_UNLOCKED') {
            details = 'üîì Account unlocked';
          } else if (eventType === 'IP_MANUALLY_UNBANNED') {
            details = 'üîß IP manually unbanned by admin';
          } else if (eventType === 'ADMIN_ACCESS') {
            details = detailsObj.allowed ? '‚úÖ Admin access granted' : '‚õî Admin access denied';
          } else {
            details = JSON.stringify(detailsObj).substring(0, 100);
          }
        } catch (e) {
          details = log.details ? String(log.details).substring(0, 100) : '‚Äî';
        }
        
        // Color code event types
        let eventClass = '';
        if (eventType.includes('FAILURE') || eventType.includes('BAN') || eventType.includes('LOCKED')) {
          eventClass = 'style="color: #dc2626; font-weight: bold;"';
        } else if (eventType.includes('SUCCESS') || eventType.includes('UNLOCKED')) {
          eventClass = 'style="color: #16a34a; font-weight: bold;"';
        } else if (eventType.includes('ADMIN')) {
          eventClass = 'style="color: #7c3aed; font-weight: bold;"';
        }

        return `
          <tr>
            <td style="white-space: nowrap;">${timestamp}</td>
            <td ${eventClass}>${eventType}</td>
            <td>${userEmail}</td>
            <td><code>${ipAddress}</code></td>
            <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${details}</td>
          </tr>
        `;
      }).join('');
    }

    // Toggle auto-refresh
    function toggleAutoRefresh() {
      autoRefreshEnabled = !autoRefreshEnabled;
      const btn = document.getElementById('refreshToggleText');
      
      if (autoRefreshEnabled) {
        btn.textContent = '‚è∏Ô∏è Pause Auto-Refresh';
        startAutoRefresh();
      } else {
        btn.textContent = '‚ñ∂Ô∏è Resume Auto-Refresh';
        stopAutoRefresh();
      }
    }

    // Start auto-refresh
    function startAutoRefresh() {
      if (refreshInterval) clearInterval(refreshInterval);
      refreshInterval = setInterval(refreshData, 30000); // 30 seconds
    }

    // Stop auto-refresh
    function stopAutoRefresh() {
      if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
      }
    }

    // Unban an IP
    async function unbanIp(ipHash) {
      if (!confirm(`Are you sure you want to unban this IP?\n\nIP Hash: ${ipHash.substring(0, 32)}...`)) {
        return;
      }

      try {
        // Check for both JWT token and admin token
        const jwtToken = localStorage.getItem('token');
        const adminToken = localStorage.getItem('secplus_admin_token_v1');
        
        if (!jwtToken && !adminToken) {
          showError('Not authenticated. Please log in.');
          return;
        }

        // Build headers with whichever token is available
        const headers = {
          'Content-Type': 'application/json'
        };
        if (jwtToken) {
          headers['Authorization'] = `Bearer ${jwtToken}`;
        } else if (adminToken) {
          headers['x-admin-token'] = adminToken;
        }

        const response = await fetch('/api/admin/unban-ip', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({ ip_hash: ipHash })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || `HTTP ${response.status}`);
        }

        // Success - refresh the dashboard
        showError(`‚úÖ IP unbanned successfully: ${ipHash.substring(0, 24)}...`);
        setTimeout(() => {
          clearError();
          refreshData();
        }, 2000);

      } catch (err) {
        console.error('Unban failed:', err);
        showError(`Failed to unban IP: ${err.message}`);
      }
    }

    // Show error message
    function showError(message) {
      const container = document.getElementById('errorContainer');
      container.innerHTML = `<div class="error-message">${message}</div>`;
    }

    // Clear error message
    function clearError() {
      document.getElementById('errorContainer').innerHTML = '';
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      initCharts();
      refreshData();
      startAutoRefresh();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      stopAutoRefresh();
    });
  </script>
</body>
</html>
