<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Attempts - CompTIA Security+ Practice Exam</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .attempts-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .attempts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .attempts-table {
      width: 100%;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .attempts-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .attempts-table th {
      background: #2c3e50;
      color: white;
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    .attempts-table td {
      padding: 15px;
      border-bottom: 1px solid #ecf0f1;
    }

    .attempts-table tr:hover {
      background: #f8f9fa;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: 600;
    }

    .status-passed {
      background: #27ae60;
      color: white;
    }

    .status-failed {
      background: #e74c3c;
      color: white;
    }

    .status-incomplete {
      background: #95a5a6;
      color: white;
    }

    .btn-view {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }

    .btn-view:hover {
      background: #2980b9;
    }

    .btn-delete {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: #c0392b;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
    }

    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .back-link {
      color: #3498db;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="attempts-container">
    <div class="attempts-header">
      <div>
        <h1>My Exam Attempts</h1>
        <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
      </div>
      <button onclick="loadAttempts()" class="btn-view">üîÑ Refresh</button>
    </div>

    <div id="attemptsContent">
      <p style="text-align: center; color: #7f8c8d;">Loading attempts...</p>
    </div>
  </div>

  <script>
    const API_URL = window.location.origin;
    let token = localStorage.getItem('token');

    if (!token) {
      window.location.href = 'index.html';
    }

    async function loadAttempts() {
      try {
        const response = await fetch(`${API_URL}/api/me/attempts`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load attempts');
        }

        const attempts = await response.json();
        displayAttempts(attempts);
      } catch (err) {
        console.error('Error loading attempts:', err);
        document.getElementById('attemptsContent').innerHTML = `
          <div class="empty-state">
            <p>‚ùå Error loading attempts: ${err.message}</p>
          </div>
        `;
      }
    }

    function displayAttempts(attempts) {
      const container = document.getElementById('attemptsContent');

      if (attempts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 64px; margin-bottom: 20px;">üìù</div>
            <h2>No Attempts Yet</h2>
            <p>You haven't taken any exams yet. Start your first exam from the dashboard!</p>
            <br>
            <a href="index.html" class="btn-view">Go to Dashboard</a>
          </div>
        `;
        return;
      }

      const tableHTML = `
        <div class="attempts-table">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Mode</th>
                <th>Duration</th>
                <th>Score</th>
                <th>Status</th>
                <th>Questions</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${attempts.map(attempt => `
                <tr>
                  <td>${formatDate(attempt.started_at)}</td>
                  <td>${attempt.mode.toUpperCase()}</td>
                  <td>${attempt.duration ? formatDuration(attempt.duration) : 'N/A'}</td>
                  <td>${attempt.score_percent !== null ? attempt.score_percent + '%' : 'Incomplete'}</td>
                  <td>${getStatusBadge(attempt)}</td>
                  <td>${attempt.correct_count || 0} / ${attempt.total_questions}</td>
                  <td>
                    ${attempt.submitted_at ? `<button class="btn-view" onclick="viewAttempt(${attempt.id})">View Details</button>` : ''}
                    <button class="btn-delete" onclick="deleteAttempt(${attempt.id})">Delete</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = tableHTML;
    }

    function getStatusBadge(attempt) {
      if (!attempt.submitted_at) {
        return '<span class="status-badge status-incomplete">Incomplete</span>';
      }
      
      const passed = attempt.score_percent >= 75;
      return passed 
        ? '<span class="status-badge status-passed">Passed</span>'
        : '<span class="status-badge status-failed">Failed</span>';
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatDuration(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = Math.floor(minutes % 60);
      return hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
    }

    function viewAttempt(attemptId) {
      window.location.href = `attempt-details.html?id=${attemptId}`;
    }

    async function deleteAttempt(attemptId) {
      if (!confirm('Are you sure you want to delete this attempt? This action cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/api/me/attempts/${attemptId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to delete attempt');
        }

        alert('Attempt deleted successfully');
        loadAttempts(); // Reload the list
      } catch (err) {
        console.error('Error deleting attempt:', err);
        alert('Error deleting attempt: ' + err.message);
      }
    }

    // Load attempts on page load
    loadAttempts();
  </script>
</body>
</html>
